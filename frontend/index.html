<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diabetes Lifestyle Web App</title>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container mt-5">

<h1 class="mb-4">Welcome to Diabetes Lifestyle Web App</h1>

<h2>Patient Information</h2>

<form id="patientForm" class="mb-3">
    <label>Name:</label>
    <input type="text" id="name" class="form-control mb-2" required>

    <label>Age:</label>
    <input type="number" id="age" class="form-control mb-2" required>

    <label>Weight (kg):</label>
    <input type="number" id="weight" class="form-control mb-2" required>

    <label>Blood Sugar (mg/dL):</label>
    <input type="number" id="blood_sugar" class="form-control mb-2" required>

    <button type="submit" class="btn btn-primary mt-2">Submit</button>
</form>

<!-- Human-readable recommendations -->
<div id="recommendations" class="mb-4"></div>

<!-- Chart Card -->
<div class="card shadow mt-4 d-none" id="chartCard">
    <div class="card-body">
        <h4 class="card-title text-info">Blood Sugar Level</h4>
        <canvas id="healthChart"></canvas>
    </div>
</div>

<script>
let chart;

document.getElementById("patientForm").addEventListener("submit", function(e) {
    e.preventDefault();

    // Get values
    const name = document.getElementById("name").value.trim();
    const age = parseInt(document.getElementById("age").value);
    const weight = parseFloat(document.getElementById("weight").value);
    const blood_sugar = parseFloat(document.getElementById("blood_sugar").value);

    // Validation
    let errors = [];
    if (!name) errors.push("Name is required.");
    if (isNaN(age) || age <= 0 || age > 120) errors.push("Age must be 1–120.");
    if (isNaN(weight) || weight <= 0 || weight > 300) errors.push("Weight must be 1–300 kg.");
    if (isNaN(blood_sugar) || blood_sugar <= 0 || blood_sugar > 500) errors.push("Blood sugar must be 1–500 mg/dL.");

    if (errors.length > 0) {
        document.getElementById("recommendations").innerHTML = 
            `<div class="alert alert-danger">${errors.join("<br>")}</div>`;
        return;
    }

    const data = { name, age, weight, blood_sugar };

    fetch("http://127.0.0.1:5000/submit-data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        // Display recommendations in cards
        const recDiv = document.getElementById("recommendations");
        recDiv.innerHTML = `
            <div class="card shadow mb-2">
                <div class="card-body">
                    <h5 class="card-title">Patient: ${result.patient.name}</h5>
                    <p>Age: ${result.patient.age}</p>
                    <p>Weight: ${result.patient.weight} kg</p>
                    <p>Blood Sugar: ${result.patient.blood_sugar} mg/dL</p>
                </div>
            </div>
            ${result.recommendations.map(r => `
                <div class="card mb-2 border-warning">
                    <div class="card-body">
                        ${r}
                    </div>
                </div>
            `).join('')}
        `;

        // Show chart
        document.getElementById("chartCard").classList.remove("d-none");
        const ctx = document.getElementById("healthChart");

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Blood Sugar'],
                datasets: [{
                    label: 'mg/dL',
                    data: [blood_sugar],
                    backgroundColor: blood_sugar > 140 ? 'red' : 'green'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, max: 300 }
                }
            }
        });
    })
    .catch(error => {
        document.getElementById("recommendations").innerHTML = 
            `<div class="alert alert-danger">Error sending data</div>`;
        console.error(error);
    });
});
</script>

</body>
</html>
